name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://unilink.example.com
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Extract version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./docker/Dockerfile.backend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/unilink-backend:latest
          ${{ secrets.DOCKER_USERNAME }}/unilink-backend:${{ steps.version.outputs.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        file: ./docker/Dockerfile.frontend
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/unilink-frontend:latest
          ${{ secrets.DOCKER_USERNAME }}/unilink-frontend:${{ steps.version.outputs.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Deploy to production
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
        
        ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST <<'EOF'
          cd /app/unilink
          git pull origin main
          docker-compose pull
          docker-compose up -d
          docker-compose exec -T backend alembic upgrade head
          echo "Deployment completed successfully"
        EOF
    
    - name: Health check
      run: |
        for i in {1..30}; do
          if curl -f https://unilink.example.com/health; then
            echo "Health check passed"
            exit 0
          fi
          echo "Waiting for service... ($i/30)"
          sleep 10
        done
        echo "Health check failed"
        exit 1
    
    - name: Notify on success
      if: success()
      run: echo "✅ Deployment successful to production"
    
    - name: Notify on failure
      if: failure()
      run: echo "❌ Deployment failed. Check logs for details."
